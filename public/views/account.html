<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twoje konto - MemoRise</title>
    <link href="/public/styles/main.css" rel="stylesheet">
</head>
<body>
    <nav>
        <div class="nav-brand">
            <a href="/dashboard"><img src="/public/images/logo.png" alt="MemoRise Logo" class="logo"></a>
        </div>
        <ul>
            <li><a href="/dashboard">Strona główna</a></li>
            <li><a href="/community">Społeczność</a></li>
            <li><a href="/progress">Twój progres</a></li>
            <li><a href="/account" class="active">Twoje konto</a></li>
            <li><a href="#" onclick="logout(); return false;">Wyloguj</a></li>
        </ul>
    </nav>

    <div class="container">
        <main class="account-container">
            <h1>Twoje konto</h1>
            
            <div class="account-sections">
                <!-- Dane profilu -->
                <section class="account-section">
                    <h2>Dane profilu</h2>
                    <div class="error-message" id="profileError" style="display: none;"></div>
                    <div class="success-message" id="profileSuccess" style="display: none;"></div>
                    
                    <form id="profileForm">
                        <div class="form-row">
                            <div class="input-group">
                                <label for="firstname">Imię</label>
                                <input type="text" id="firstname" name="firstname" required>
                            </div>
                            <div class="input-group">
                                <label for="lastname">Nazwisko</label>
                                <input type="text" id="lastname" name="lastname" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" disabled>
                            <small>Email nie może być zmieniony</small>
                        </div>
                        <div class="input-group">
                            <label for="bio">O mnie</label>
                            <textarea id="bio" name="bio" rows="3" placeholder="Napisz coś o sobie..."></textarea>
                        </div>
                        <button type="submit" class="btn-primary">Zapisz zmiany</button>
                    </form>
                </section>
                
                <!-- Zmiana hasła -->
                <section class="account-section">
                    <h2>Zmiana hasła</h2>
                    <div class="error-message" id="passwordError" style="display: none;"></div>
                    <div class="success-message" id="passwordSuccess" style="display: none;"></div>
                    
                    <form id="passwordForm">
                        <div class="input-group">
                            <label for="currentPassword">Aktualne hasło</label>
                            <input type="password" id="currentPassword" name="currentPassword" required>
                        </div>
                        <div class="input-group">
                            <label for="newPassword">Nowe hasło</label>
                            <input type="password" id="newPassword" name="newPassword" required minlength="8">
                            <small>Minimum 8 znaków</small>
                        </div>
                        <div class="input-group">
                            <label for="confirmPassword">Potwierdź nowe hasło</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn-primary">Zmień hasło</button>
                    </form>
                </section>
                
                <!-- Informacje o koncie -->
                <section class="account-section account-info">
                    <h2>Informacje o koncie</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Rola:</span>
                            <span class="info-value" id="userRole">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value" id="userStatus">-</span>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="/public/scripts/api.js"></script>
    <script src="/public/scripts/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            setupForms();
        });
        
        async function loadProfile() {
            try {
                const result = await API.auth.me();
                
                if (result.ok) {
                    const user = result.data;
                    document.getElementById('firstname').value = user.firstname || '';
                    document.getElementById('lastname').value = user.lastname || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('bio').value = user.bio || '';
                    
                    const roleLabels = {
                        'student': 'Uczeń',
                        'teacher': 'Nauczyciel',
                        'admin': 'Administrator'
                    };
                    document.getElementById('userRole').textContent = roleLabels[user.role] || user.role;
                    document.getElementById('userStatus').textContent = user.enabled ? 'Aktywny' : 'Nieaktywny';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        function setupForms() {
            // Formularz profilu
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const errorEl = document.getElementById('profileError');
                const successEl = document.getElementById('profileSuccess');
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
                
                try {
                    const result = await API.post('/api/auth/profile', {
                        firstname: document.getElementById('firstname').value,
                        lastname: document.getElementById('lastname').value,
                        bio: document.getElementById('bio').value
                    });
                    
                    if (result.ok) {
                        successEl.textContent = 'Profil został zaktualizowany';
                        successEl.style.display = 'block';
                    } else {
                        errorEl.textContent = result.error?.message || 'Błąd aktualizacji';
                        errorEl.style.display = 'block';
                    }
                } catch (error) {
                    errorEl.textContent = 'Wystąpił błąd';
                    errorEl.style.display = 'block';
                }
            });
            
            // Formularz hasła
            document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const errorEl = document.getElementById('passwordError');
                const successEl = document.getElementById('passwordSuccess');
                errorEl.style.display = 'none';
                successEl.style.display = 'none';
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    errorEl.textContent = 'Hasła nie są identyczne';
                    errorEl.style.display = 'block';
                    return;
                }
                
                try {
                    const result = await API.post('/api/auth/password', {
                        currentPassword: document.getElementById('currentPassword').value,
                        newPassword: newPassword
                    });
                    
                    if (result.ok) {
                        successEl.textContent = 'Hasło zostało zmienione';
                        successEl.style.display = 'block';
                        e.target.reset();
                    } else {
                        errorEl.textContent = result.error?.message || 'Błąd zmiany hasła';
                        errorEl.style.display = 'block';
                    }
                } catch (error) {
                    errorEl.textContent = 'Wystąpił błąd';
                    errorEl.style.display = 'block';
                }
            });
        }
    </script>
</body>
</html>
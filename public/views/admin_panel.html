<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel administratora - MemoRise</title>
    <link href="/public/styles/main.css" rel="stylesheet">
</head>
<body>
    <nav>
        <div class="nav-brand">
            <a href="/admin"><img src="/public/images/logo.png" alt="MemoRise Logo" class="logo"></a>
        </div>
        <ul>
            <li><a href="/admin" class="active">Panel admina</a></li>
            <li><a href="/account">Twoje konto</a></li>
            <li><a href="#" onclick="logout(); return false;">Wyloguj</a></li>
        </ul>
    </nav>

    <div class="container">
        <main class="admin-container">
            <h1>Panel administratora</h1>
            
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="users">U≈ºytkownicy</button>
                <button class="admin-tab" data-tab="classes">Wszystkie klasy</button>
            </div>
            
            <!-- Zak≈Çadka u≈ºytkownik√≥w -->
            <section class="admin-section" id="usersSection">
                <div class="section-header">
                    <h2>ZarzƒÖdzanie u≈ºytkownikami</h2>
                    <div class="search-filter">
                        <input type="text" id="userSearch" placeholder="Szukaj u≈ºytkownika...">
                    </div>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Imiƒô i nazwisko</th>
                                <th>Email</th>
                                <th>Rola</th>
                                <th>Status</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="6" class="loading">≈Åadowanie...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Zak≈Çadka klas -->
            <section class="admin-section" id="classesSection" style="display: none;">
                <div class="section-header">
                    <h2>Wszystkie klasy</h2>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table" id="classesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nazwa</th>
                                <th>Nauczyciel</th>
                                <th>Kod do≈ÇƒÖczenia</th>
                                <th>Jƒôzyk</th>
                                <th>Utworzona</th>
                            </tr>
                        </thead>
                        <tbody id="classesTableBody">
                            <tr><td colspan="6" class="loading">≈Åadowanie...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal zmiany roli -->
    <div id="changeRoleModal" class="modal" style="display: none;">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>Zmie≈Ñ rolƒô u≈ºytkownika</h2>
                <button class="close-btn" onclick="closeModal('changeRoleModal')">&times;</button>
            </div>
            <form id="changeRoleForm">
                <input type="hidden" id="changeRoleUserId">
                <p>U≈ºytkownik: <strong id="changeRoleUserName"></strong></p>
                <div class="input-group">
                    <label for="newRole">Nowa rola</label>
                    <select id="newRole" name="role" required>
                        <option value="student">Ucze≈Ñ</option>
                        <option value="teacher">Nauczyciel</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('changeRoleModal')">Anuluj</button>
                    <button type="submit" class="btn-primary">Zmie≈Ñ rolƒô</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/public/scripts/api.js"></script>
    <script src="/public/scripts/auth.js"></script>
    <script>
        let allUsers = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            setupTabs();
            setupSearch();
            setupForms();
        });
        
        function setupTabs() {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
                    
                    tab.classList.add('active');
                    const sectionId = tab.dataset.tab + 'Section';
                    document.getElementById(sectionId).style.display = 'block';
                    
                    if (tab.dataset.tab === 'classes') {
                        loadClasses();
                    }
                });
            });
        }
        
        function setupSearch() {
            document.getElementById('userSearch').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allUsers.filter(u => 
                    u.firstname.toLowerCase().includes(query) ||
                    u.lastname.toLowerCase().includes(query) ||
                    u.email.toLowerCase().includes(query)
                );
                renderUsers(filtered);
            });
        }
        
        async function loadUsers() {
            try {
                const result = await API.get('/api/admin/users');
                
                if (result.ok) {
                    allUsers = result.data;
                    renderUsers(allUsers);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Brak u≈ºytkownik√≥w</td></tr>';
                return;
            }
            
            const roleLabels = {
                'student': '<span class="badge badge-student">Ucze≈Ñ</span>',
                'teacher': '<span class="badge badge-teacher">Nauczyciel</span>',
                'admin': '<span class="badge badge-admin">Admin</span>'
            };
            
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${escapeHtml(u.firstname)} ${escapeHtml(u.lastname)}</td>
                    <td>${escapeHtml(u.email)}</td>
                    <td>${roleLabels[u.role] || u.role}</td>
                    <td>${u.enabled ? '<span class="status-active">Aktywny</span>' : '<span class="status-inactive">Nieaktywny</span>'}</td>
                    <td>
                        <button class="btn-sm btn-secondary" onclick="showChangeRoleModal(${u.id}, '${escapeHtml(u.firstname)} ${escapeHtml(u.lastname)}', '${u.role}')">Zmie≈Ñ rolƒô</button>
                        <button class="btn-sm ${u.enabled ? 'btn-danger' : 'btn-primary'}" onclick="toggleUserStatus(${u.id}, ${u.enabled})">
                            ${u.enabled ? 'Zablokuj' : 'Odblokuj'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadClasses() {
            const tbody = document.getElementById('classesTableBody');
            
            try {
                const result = await API.get('/api/admin/classes');
                
                if (result.ok && result.data.length > 0) {
                    const flags = {'de': 'üá©üá™', 'en': 'üá¨üáß', 'es': 'üá™üá∏', 'fr': 'üá´üá∑', 'it': 'üáÆüáπ', 'ru': 'üá∑üá∫'};
                    
                    tbody.innerHTML = result.data.map(c => `
                        <tr>
                            <td>${c.id}</td>
                            <td>${escapeHtml(c.name)}</td>
                            <td>${escapeHtml(c.teacherName)}</td>
                            <td><code>${c.joinCode}</code></td>
                            <td>${flags[c.language] || c.language || '-'}</td>
                            <td>${new Date(c.createdAt).toLocaleDateString('pl-PL')}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">Brak klas</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="error">B≈ÇƒÖd ≈Çadowania</td></tr>';
            }
        }
        
        function showChangeRoleModal(userId, userName, currentRole) {
            document.getElementById('changeRoleUserId').value = userId;
            document.getElementById('changeRoleUserName').textContent = userName;
            document.getElementById('newRole').value = currentRole;
            document.getElementById('changeRoleModal').style.display = 'flex';
        }
        
        function setupForms() {
            document.getElementById('changeRoleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userId = document.getElementById('changeRoleUserId').value;
                const newRole = document.getElementById('newRole').value;
                
                try {
                    const result = await API.put(`/api/admin/users/${userId}/role`, { role: newRole });
                    
                    if (result.ok) {
                        closeModal('changeRoleModal');
                        loadUsers();
                    } else {
                        alert('B≈ÇƒÖd: ' + (result.error?.message || 'Nie uda≈Ço siƒô zmieniƒá roli'));
                    }
                } catch (error) {
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd');
                }
            });
        }
        
        async function toggleUserStatus(userId, currentStatus) {
            if (!confirm(`Czy na pewno chcesz ${currentStatus ? 'zablokowaƒá' : 'odblokowaƒá'} tego u≈ºytkownika?`)) {
                return;
            }
            
            try {
                const result = await API.put(`/api/admin/users/${userId}/status`, { enabled: !currentStatus });
                
                if (result.ok) {
                    loadUsers();
                } else {
                    alert('B≈ÇƒÖd: ' + (result.error?.message || 'Nie uda≈Ço siƒô zmieniƒá statusu'));
                }
            } catch (error) {
                alert('WystƒÖpi≈Ç b≈ÇƒÖd');
            }
        }
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>